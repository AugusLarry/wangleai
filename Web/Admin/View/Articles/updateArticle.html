<extend name="Public:layout"/>
<block name="seo">
   <title>编辑文章</title>
   <meta name="keywords" content="">
   <meta name="description" content="">
</block>
<block name="css">
   <link rel="stylesheet" href="__PUBLIC__/plugins/icheck/css/_all.css">
   <link rel="stylesheet" href="__PUBLIC__/plugins/bigautocomplete/css/jquery.bigautocomplete.css">
</block>
<block name="content">
<div class="row">
   <div class="col-md-12">
      <ul class="breadcrumb">
         <li><a href="{:U('Admin/Index/index')}">首页</a></li>
         <li><a href="{:U('Admin/Articles/index')}">文章管理</a></li>
         <li class="active">编辑文章</li>
      </ul>
   </div>
   <div class="col-md-12">
      <div class="panel panel-default">
         <div class="panel-heading"><h3 class="panel-title">编辑文章</h3></div>
         <div class="panel-body">
            <form class="form-horizontal form-border" id="updateArticle" action="{:U('Admin/Articles/updateArticleForm')}" method="post">
               <div class="form-group has-feedback">
                  <label class="col-sm-3 control-label">标题</label>
                  <div class="col-sm-6">
                     <input type="text" class="form-control" name="post_title" value="{$post.post_title}">
                  </div>
               </div>
               <div class="form-group has-feedback">
                  <label class="col-sm-3 control-label">所属分类</label>
                  <div class="col-sm-6">
                     <select name="post_category" class="form-control input-sm">
                        <foreach name="category" item="v">
                           <option value="{$v.id}" <if condition="$v['id'] eq $post['category']">selected</if>>{$v.html}{$v.name}</option>
                        </foreach>
                     </select>
                  </div>
               </div>
               <div class="form-group">
                  <label class="col-sm-3 control-label">描述</label>
                  <div class="col-sm-6">
                     <textarea class="form-control" rows="3" name="post_description">{$post.post_description}</textarea>
                  </div>
               </div>
               <div class="form-group has-feedback">
                  <label class="col-sm-3 control-label">标签</label>
                  <div class="col-sm-5 autoSelect">
                     <input type="text" class="form-control" id="post_terms" autocomplete="off">
                     <p class="help-block" id="help-block">
                     <foreach name="tags" item="v">
                     <span class='tag'>{$v},<button type='button' class='close'>×</button></span>
                     </foreach>
                     </p>
                  </div>
                  <label class="col-sm-1" id="clickTag">
                     <button type="button" class="btn btn-primary" id="add-tag">添加</button>
                  </label>
               </div>
               <div class="form-group has-feedback">
                  <label class="col-sm-3 control-label">属性</label>
                  <div class="col-sm-6">
                     <?php foreach ($property as $v): ?>
                        <label class="checkbox-inline">
                        <input class="icheck" type="checkbox" name="property[]" value="{$v.id}"
                           <?php foreach ($attr as $val): ?>
                              <?php if ($v['id'] == $val): ?>
                                 checked="checked"
                              <?php endif ?>
                           <?php endforeach ?>
                        >{$v.property}
                        </label>
                     <?php endforeach ?>
                  </div>
               </div>
               <div class="form-group">
                  <label class="col-sm-3 control-label">类型</label>
                  <div class="col-sm-6">
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="post_type" value="0" <if condition="$post.post_type eq 0">checked</if>>普通</label>
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="post_type" value="1" <if condition="$post.post_type eq 1">checked</if>>心情</label>
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="post_type" value="2" <if condition="$post.post_type eq 2">checked</if>>音乐</label>
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="post_type" value="3" <if condition="$post.post_type eq 3">checked</if>>图片</label>
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="post_type" value="4" <if condition="$post.post_type eq 4">checked</if>>视频</label>
                  </div>
               </div>
               <div class="form-group">
                  <label class="col-sm-3 control-label">状态</label>
                  <div class="col-sm-6">
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="post_status" value="0" <if condition="$post.post_status eq 0">checked</if>>发布</label>
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="post_status" value="1" <if condition="$post.post_status eq 1">checked</if>>草稿</label>
                  </div>
               </div>
               <div class="form-group">
                  <label class="col-sm-3 control-label">评论状态</label>
                  <div class="col-sm-6">
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="comment_status" value="0" <if condition="$post.comment_status eq 0">checked</if>>开启评论</label>
                     <label class="radio-inline">
                     <input class="icheck" type="radio" name="comment_status" value="1" <if condition="$post.comment_status eq 1">checked</if>>关闭评论</label>
                  </div>
               </div>
               <div class="form-group has-feedback">
                  <label class="col-sm-3 control-label">内容</label>
                  <div class="col-sm-6">
                     <script id="post_content" name="post_content" type="text/plain">{$post.post_content|htmlspecialchars_decode}</script>
                  </div>
               </div>
               <div class="form-group">
                  <div class="col-sm-2 col-sm-offset-4">
                     <textarea class="form-control hidden" rows="3" name="tags" id="tags">
                        <if condition="!empty($tags)">
                        <foreach name="tags" item="v">{$v},</foreach>
                        </if>
                     </textarea>
                     <input type="hidden" class="form-control" name="post_author" value="{$Think.session.uname}">
                     <input type="hidden" class="form-control" name="id" value="{$post.id}">
                     <input type="hidden" class="form-control" name="old_category" value="{$post.category}">
                     <input type="submit" class="btn btn-primary btn-block" id="addRule" value="提交">
                  </div>
               </div>
            </form>
         </div>
      </div>
   </div>
</div>
</block>
<block name="js">
<script src="__PUBLIC__/plugins/icheck/js/icheck.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="__PUBLIC__/ueditor/ueditor.all.js"></script>
<script src="__PUBLIC__/plugins/validation/js/jquery.validate.min.js"></script>
<script src="__PUBLIC__/plugins/bigautocomplete/js/jquery.bigautocomplete.js"></script>
<script>
   $(document).ready(function() {
      $('input').iCheck({
         checkboxClass: 'icheckbox_flat-grey',
         radioClass: 'iradio_flat-grey'
      });
      var ue = UE.getEditor('post_content', {
         initialFrameHeight : 300,
      });
      $("#updateArticle").validate({
         errorClass : "help-block",
         errorElement : "p",
         rules : {
            post_title : {required : true, rangelength : [2, 60]},
            post_category : {required : true},
            post_content : {required : true},
         },
         highlight : function(element) {
            $(element).closest('.form-group').removeClass('success').addClass('has-error');
            $(element).after('<span class="glyphicon glyphicon-remove form-control-feedback" aria-hidden="true"></span>');
         },
         success : function(element) {
            $(element).closest('.form-group').removeClass('has-error').addClass('has-success');
            element.siblings("span").remove();
            element.after('<span class="glyphicon glyphicon-ok form-control-feedback" aria-hidden="true"></span>');
         },
         messages : {
            post_title : {required : "分类名称不能为空!", rangelength : "名称长度只能在2-60个字符之间!"},
            post_category : {required : "所属分类不能为空!"},
            post_content : {required : "内容不能为空!"},
         },
         submitHandler : function(form){
            $(form).submit();
         }
      });
      $("#post_terms").bigAutocomplete({
         url : "{:U('Admin/Articles/getTags')}",
         callback : function (data){
            //console.log(data);
         }
      })
      $("#clickTag").delegate("button", "click", function(){
         var str = $.trim($("#post_terms").val());
         var tags = $.trim($("#tags").val());
         if (str == "") {
            return false;
         }
         if ($("#help-block").find("span").text().indexOf(str) <= 0) {
            str = str.replace(/,/gm, "-");
            str += ",";
            $("#help-block").append("<span class='tag'>" + str + "<button type='button' class='close'>×</button>");
            $("#tags").val(tags += str);
         }
         $("#post_terms").val("");
      })
      $("#help-block").delegate("button", "click", function(){
         var str = $(this).parent("span").html();
         var index = str.indexOf(",");
         str = str.substring(0, index+1);
         var tag = $.trim($("#tags").val()).replace(str, "");
         $("#tags").val(tag);
         $(this).parent("span").remove();
      })
   });
</script>
</block>