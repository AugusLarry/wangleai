<extend name="Public:layout"/>
<block name="seo">
	<title>评论列表</title>
	<meta name="keywords" content="">
	<meta name="description" content="">
</block>
<block name="css">
	<link rel="stylesheet" href="__PUBLIC__/plugins/dataTables/css/dataTables.css">
	<link rel="stylesheet" href="__PUBLIC__/css/site.css">
	<!-- Editor-->
	<link rel="stylesheet" href="__PUBLIC__/plugins/bootstrap-wysihtml5/css/bootstrap-wysihtml5.css">
</block>
<block name="content">
	<div class="row">
		<div class="col-md-12">
			<ul class="breadcrumb">
				<li><a href="{:U('Admin/Index/index')}">首页</a></li>
				<li class="active">
					<?php
            			if (strtolower(ACTION_NAME) == 'index') {
               				echo "评论管理";
            			} elseif (strtolower(ACTION_NAME) == 'trash') {
              				echo "回收站";
            			} elseif (strtolower(ACTION_NAME) == 'junk') {
            				echo "垃圾评论";
            			} elseif (strtolower(ACTION_NAME) == 'copending') {
            				echo "待审评论";
            			}
         			?>
				</li>
			</ul>
		</div>
		<div class="col-md-12">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title">
						<commentstitle/>
					</h3>
				</div>
				<div class="panel-body">
					<div class="dataTables_wrapper no-footer">
						<div class="row">
							<div class="col-xs-6">
								<div class="dataTables_length">
									<label>
										<select name="onepagenum" class="form-control input-sm" id="onepagenum">
											<option value="" selected="selected">请选择</option>
											<option value="10">10</option>
											<option value="25">25</option>
											<option value="50">50</option>
											<option value="100">100</option>
										</select>　条每页
									</label>
								</div>
							</div>
							<div class="col-xs-6">
								<div id="example_filter" class="dataTables_filter">
									<label>搜索:　<input type="search" class="form-control input-sm"></label>
								</div>
							</div>
						</div>
						<table class="table table-hover">
							<thead>
								<tr>
									<th width="5%">#</th>
									<th width="8%">层级</th>
									<th width="25%">作者</th>
									<th width="45%">评论</th>
									<th width="17%">回复至</th>
								</tr>
							</thead>
							<tbody>
								<foreach name="comments" item="v">
									<tr class='titleHover <if condition="$v.comment_type eq 0">danger</if>'>
										<td>{$v.comment_id}</td>
										<td>
											<php>
												switch ($v['level']) {
													case "0":
														echo "顶级评论";
														break;
													case "1":
														echo "二级评论";
														break;
													case "2":
														echo "三级评论";
														break;
													case "3":
														echo "四级评论";
														break;
													default:
														echo "多级评论";
												}
											</php>
										</td>
										<td>
											<div class="cl-avatar">
												<if condition="$v.avatar eq ''">
													<img src="/Public/static-index/img/avatar.jpg" alt="">
												<else/>
													<img src="{$v.avatar}" alt="" width="32">
												</if>
											</div>
											<div class="cl-author">
												<span>{$v.comment_author}</span>
												<a href="{$v.comment_author_url}"><span>{$v.comment_author_url}</span></a>
												<a href="mailto:{$v.comment_author_email}"><span>{$v.comment_author_email}</span></a>
												<a href=""><span>{$v.comment_author_ip}</span></a>
											</div>
										</td>
										<td>
											<div class="cl-info">
											提交于<a href="{:U('/Index/' . $v['pid'])}/#comment-{$v.comment_id}" target="_blank">{$v.created_at|date="Y-m-d H:i:s", ###}</a>
											<?php
											if ($v['comment_parent'] != 0) {
												$parent_author = M("Comments")->where(['comment_id' => $v['comment_parent']])->getField("comment_author");
												echo " | 回复给<a href='" . U("/Index/" . $v['pid']) . "/#comment-" . $v['comment_parent'] . "' target='_blank'>" . $parent_author . "</a>";
											}
											?>
											</div>
											<div class="cl-content">{$v.comment_content}</div>
											<div class="cl-handle hidden">
												<if condition="$v.comment_type eq 0">
												<a href="{:U('Admin/Comments/audit', ['id' => $v['comment_id'], 'type' => '1'])}">批准</a>
												<else/>
												<a href="{:U('Admin/Comments/audit', ['id' => $v['comment_id'], 'type' => '0'])}">驳回</a>
												</if>
												<a href="javascript:void(0);" onclick="reply(this, {$v.comment_id}, {$v.pid});">回复</a>
												<a href="javascript:void(0);" onclick="update(this, {$v.comment_id}, '{$v.comment_author}', '{$v.comment_author_email}', '{$v.comment_author_url}', '{$v.comment_content}')">编辑</a>
												<a href="{:U('Admin/Comments/audit', ['id' => $v['comment_id'], 'type' => '2'])}">垃圾评论</a>
												<a href="{:U('Admin/Comments/audit', ['id' => $v['comment_id'], 'type' => '3'])}">移至回收站</a>
											</div>
										</td>
										<td>
											<div class="cl-response">
												<a href="{:U('Admin/Articles/updateArticle', ['id' => $v['pid']])}" target="_blank">{$v.post_title}</a>
												<a href="{:U('/Index/' . $v['pid'])}" target="_blank">查看文章</a>
												<if condition="$v.comment_count gt 0">
												<a href="{:U('Admin/Comments/getCommentsByArticle', ['comment_post_id' => $v['pid'], 'comment_type' => 1])}" class="inline"><span class="label label-info inbox-notification count" data-toggle="tooltip" data-placement="top" title="" data-original-title="共{$v.comment_count}条已审核评论">{$v.comment_count}</span></a>
												<else/>
												<span class="label label-info inbox-notification count" data-toggle="tooltip" data-placement="top" title="" data-original-title="{$v.comment_count}条评论">{$v.comment_count}</span>
												</if>
												<?php
												$no_audit_comments = M("Comments")->where(['comment_post_id' => $v['pid'], 'comment_type' => 0])->count();
												if ($no_audit_comments > 0) {
													echo "<a href='" . U("Admin/Comments/getCommentsByArticle", ["comment_post_id" => $v["pid"], "comment_type" => 0]) . "' class='label label-info inbox-notification count no_audit_comments' data-toggle='tooltip' data-placement='top' title='' data-original-title='共" . $no_audit_comments . "条待审评论'><span>" . $no_audit_comments . "</span></a>";
												}
												?>
											</div>
										</td>
									</tr>
								</foreach>
							</tbody>
						</table>
					</div>
				</div>
				<div class="panel-footer">
					<div class="row">
						<div class="col-xs-12">
							<div class="dataTables_paginate">
								{$show}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</block>
<block name="js">
	<script src="__PUBLIC__/plugins/icheck/js/icheck.min.js"></script>
	<!--Page Level JS-->
	<script src="__PUBLIC__/plugins/bootstrap-wysihtml5/js/wysihtml5-0.3.0.js"></script>
	<script src="__PUBLIC__/plugins/bootstrap-wysihtml5/js/bootstrap3-wysihtml5.js"></script>
	<script>
		$(document).ready(function() {
			$('input').iCheck({
				checkboxClass: 'icheckbox_flat-grey',
				radioClass: 'iradio_flat-grey'
			});
			$('.count').tooltip();
			$("#onepagenum").change(function(){
				var str = window.location.href;
				if (str.indexOf("/onepagenum/") > 0) {
					window.location.href = str.replace(/\/onepagenum\/\d+/g, "") + "/onepagenum/" + $(this).children('option:selected').val();
				} else {
					window.location.href = str + "/onepagenum/" + $(this).children('option:selected').val();
				}
			})
			$(".titleHover").mouseover(function(){
				$(this).find("div.hidden").removeClass("hidden").addClass("show");
				$(this).mouseout(function(){
					$(this).find("div.show").removeClass("show").addClass("hidden");
				})
			})
			$(".repeal, .addtrash, .deleteArticle").click(function(){
				if (!confirm("确定要" + $(this).html() + "吗?")) {
					return false;
				} else {
					return true;
				}
			})
		});
		//obj当前对象
		//cid当前评论ID
		//pid文章ID
		function reply(obj, cid, pid){
			var str = "<tr class='reply'>";
				str += "<td colspan='5'>";
				str += '<form action="{:U(\'reply\')}" method="post">';
				str += "<div class='cl-reply-"+cid+"'>";
				str += "<textarea class='textarea form-control' name='content' rows='10' cols='80' placeholder='请输入回复内容...' style='width: 100%;height: 100px;'></textarea>";
				str += "</div>";
				str += "<div class='cl-reply-btn'>";
				str += "<a class='btn btn-info btn-sm btn-square' href='javascript:void(0);' onclick='unreply(this);'>取消</a>";
				str += "<input type='hidden' name='parent' value='"+cid+"'/>";
				str += "<input type='hidden' name='pid' value='"+pid+"'/>";
				str += "<input type='submit' class='btn btn-default btn-sm btn-square pull-right' value='回复'/>"
				str += "</div>";
				str += '</form>';
				str += "</td>";
				str += "</tr>";
			if ($(obj ).parents("tbody" ).find("tr.reply").length > 0 ) {
				$("tr.reply" ).remove();
			};
			$("tr.update" ).remove();
			$(obj).parents("tr" ).after(str);
			$('.textarea').wysihtml5();
		}
		function unreply(obj){
			$(obj ).parents("tr" ).remove();
		}
		//obj当前对象
		//id当前评论id
		//author当前评论作者
		//email当前评论作者email
		//url当前评论作者url
		//content当前评论内容
		function update(obj, id, author, email, url, content){
			var str = "<tr class='update'>";
				str += "<td colspan='5'>";
				str += '<form class="form-horizontal" action="{:U(\'update\')}" method="post">';
				str += "<div class='cl-update-"+id+"'>";
				str += "<div class='form-group'>";
				str += "<label for='author' class='col-md-1 control-label'>评论者:</label>";
				str += "<div class='col-md-3'>";
				str += "<input type='text' name='author' class='form-control' value='" + author +"'/>";
				str += "</div>";
				str += "<label for='email' class='col-md-1 control-label'>邮箱:</label>";
				str += "<div class='col-md-3'>";
				str += "<input type='text' name='email' class='form-control' value='" + email + "'/>";
				str += "</div>";
				str += "<label for='url' class='col-md-1 control-label'>网站:</label>";
				str += "<div class='col-md-3'>";
				str += "<input type='text' name='url' class='form-control' value='" + url + "'/>";
				str += "</div>";
				str += "</div>";
				str += "<div class='form-group'>";
				str += "<div class='col-md-12'>";
				str += "<textarea name='content' class='form-control'>" + content + "</textarea>";
				str += "</div>";
				str += "</div>";
				str += "<div class='form-group' style='margin-bottom: 0;'>";
				str += "<div class='col-md-2'>";
				str += "<a class='btn btn-info btn-sm btn-square' href='javascript:void(0);' onclick='unupdate(this);'>取消</a>";
				str += "</div>";
				str += "<div class='col-md-2 col-md-offset-8'>";
				str += "<input type='hidden' name='id' value='" + id + "'/>"
				str += "<input type='submit' class='btn btn-default btn-sm btn-square pull-right' value='更新'/>";
				str += "</div>";
				str += "</div>";
				str += "</div>";
				str += '</form>';
				str += "</td>";
				str += "</tr>";
			if ($(obj ).parents("tbody" ).find("tr.update").length > 0 ) {
				$("tr.update" ).remove();
			};
			$("tr.reply" ).remove();
			$(obj).parents("tr" ).after(str);
		}
		function unupdate(obj){
			$(obj ).parents("tr" ).remove();
		}
	</script>
</block>